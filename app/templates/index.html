{% extends 'layout.html' %}

{% block content %}
<h1 class="text-center mb-2">Home</h1>
<h2 class="text-center">Welcome {{current_user.username}}</h2>
<input id="user_id" hidden value="{{ current_user.id }}"> </input>

<button class="start-button" >Start recording</button>
<button class="stop-button" >Stop recording</button>
<select name="question-selection" id="">
  <option value="1">Question1</option>
  <option value="2">Question2</option>
  <option value="3">Question3</option>
  <option value="4">Question4</option>
</select>

<script type="text/javascript">
   
      const uploadURL = "{{ url_for('audio_upload') }}";
      const startButton = document.querySelector(".start-button");
      const stopButton = document.querySelector(".stop-button")
      const userID = document.getElementById("user_id").value;
      
      startButton.addEventListener("click", function() {
        //make sure that mediaDevices is supported
        if (!navigator.mediaDevices) {
          console.error("getUserMedia not supported.")
          return;
        }

        const constraints = { audio: true };
        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            let chunks = []
            let recorder = new MediaRecorder(stream);
            recorder.ondataavailable = event => {
                chunks.push(event.data);
            };
            
            
            
            //when click the stop button we stop recording 
            
            stopButton.addEventListener("click",()=>{
              console.log("stop recording")
              recorder.stop();
            })
            
            
            
            
            recorder.onstart = event => {
              console.log("Recording started.");
              startButton.disabled = true;
            };
            recorder.start();
            
            
            
            
            recorder.onstop = event => {
              console.log("Recording stopped.")
              let blob = new Blob(chunks, { type: recorder.mimeType }); 
              chunks = [];
              startButton.disabled = false;

              let formData = new FormData();
              formData.append('audio_file', blob);
              

              fetch(uploadURL, {
                method: "POST",
                cache: "no-cache",
                body: formData
              }).then(resp => {
                if (resp.status === 200) {
                  window.location.reload(true);
                } else {
                  console.error("Error:", resp)
                }
              }).catch(err => {
                console.error(err);
              });
            };
        })
        
        
        .catch(function(err) {
            console.error(err);
        });
      });
    ;
    </script>
{% endblock %}